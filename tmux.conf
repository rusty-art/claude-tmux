set -g history-limit 50000
set -g mouse on

# --- Smart copy-mode: auto-exit on live page, stay when scrolled back ---
#
# Uses pane option @fresh_copy as a flag:
#   Drag from live pane  → sets @fresh_copy=1 → DragEnd uses copy-pipe-and-cancel (exits, no jump)
#   Drag while scrolled up → @fresh_copy unset → DragEnd uses copy-pipe-no-clear (stays at position)

# Override root drag: set flag before entering copy-mode
bind-key -T root MouseDrag1Pane if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" { send-keys -M } { set -p @fresh_copy 1 ; copy-mode -M }

# DragEnd: smart behavior based on flag
bind-key -T copy-mode MouseDragEnd1Pane if-shell -F "#{@fresh_copy}" { send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i" ; set -up @fresh_copy } { send-keys -X copy-pipe-no-clear "xclip -selection clipboard -i" }
bind-key -T copy-mode-vi MouseDragEnd1Pane if-shell -F "#{@fresh_copy}" { send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i" ; set -up @fresh_copy } { send-keys -X copy-pipe-no-clear "xclip -selection clipboard -i" }

# Double-click from live pane: select word, copy, exit
bind-key -T root DoubleClick1Pane select-pane -t = \; if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" { send-keys -M } { copy-mode ; send-keys -X select-word ; send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i" }
# Double-click while scrolled up: select word, copy, stay
bind-key -T copy-mode DoubleClick1Pane select-pane \; send-keys -X select-word \; send-keys -X copy-pipe-no-clear "xclip -selection clipboard -i"
bind-key -T copy-mode-vi DoubleClick1Pane select-pane \; send-keys -X select-word \; send-keys -X copy-pipe-no-clear "xclip -selection clipboard -i"

# Triple-click from live pane: select line, copy, exit
bind-key -T root TripleClick1Pane select-pane -t = \; if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" { send-keys -M } { copy-mode ; send-keys -X select-line ; send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i" }
# Triple-click while scrolled up: select line, copy, stay
bind-key -T copy-mode TripleClick1Pane select-pane \; send-keys -X select-line \; send-keys -X copy-pipe-no-clear "xclip -selection clipboard -i"
bind-key -T copy-mode-vi TripleClick1Pane select-pane \; send-keys -X select-line \; send-keys -X copy-pipe-no-clear "xclip -selection clipboard -i"

# --- Copy-mode navigation ---

# Left-click in copy-mode: clear selection, stay at scroll position
bind-key -T copy-mode MouseDown1Pane send-keys -X clear-selection
bind-key -T copy-mode-vi MouseDown1Pane send-keys -X clear-selection

# Right-click in copy-mode: paste + exit
bind-key -T copy-mode MouseDown3Pane send-keys -X cancel \; run-shell -b "xclip -selection clipboard -o | tmux load-buffer - && tmux paste-buffer -dr"
bind-key -T copy-mode-vi MouseDown3Pane send-keys -X cancel \; run-shell -b "xclip -selection clipboard -o | tmux load-buffer - && tmux paste-buffer -dr"

# Right-click on live pane: paste from clipboard
bind-key -n MouseDown3Pane run-shell -b "xclip -selection clipboard -o | tmux load-buffer - && tmux paste-buffer -dr"

# Ctrl+B ] paste from clipboard
bind-key ] run-shell "xclip -selection clipboard -o | tmux load-buffer - && tmux paste-buffer -dr"

# OSC 52 clipboard support
set -s set-clipboard on
